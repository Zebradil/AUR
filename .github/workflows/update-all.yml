# This workflow is triggered on a schedule, and will update all the
# AUR packages in the repository.

---
name: Update all packages

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches:
      - "*"

jobs:
  list_packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - id: build
        run: |
          cd packages
          echo "packages=$(ls | jq -Rnc '[inputs]')" >> $GITHUB_OUTPUT
      - name: Print result
        run: echo ${{ steps.build.outputs.packages }}
    outputs:
      packages: ${{ steps.build.outputs.packages }}
  update_packages:
    needs: list_packages
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.list_packages.outputs.packages) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Generate PKGBUILD
        run: |
          ./scripts/bin/gen_pkgbuild ${{ matrix.package }}
      - name: Push to AUR
        uses: KSXGitHub/github-actions-deploy-aur@<TAG>
        with:
          pkgname: ${{ matrix.package }}
          pkgbuild: ./packages/${{ matrix.package }}/PKGBUILD
          commit_message: "Automatic update"
          commit_username: "AUR Bot"
          commit_email: "german.lashevich+aur-bot@gmail.com"
          allow_empty_commits: false
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
